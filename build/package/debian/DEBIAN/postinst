#!/bin/sh

# Ensure the script is run as root
if [ "$(id -u)" -ne 0 ]; then
  echo "This script must be run as root"
  exit 1
fi

# Add overlay
dtoverlay pilot

# Update the list of modules for modprobe
depmod

# Array of modules
modules=("pilot" "pilot_io" "pilot_tty" "pilot_rtc" "pilot_slcd" "pilot_plc" "pilot_fpga")

# Load the modules
for module in "${modules[@]}"; do
    modprobe $module || { echo "Failed to load $module module"; exit 1; }
done

# Add the modules to /etc/modules so they get loaded on system startup
for module in "${modules[@]}"; do
    # Check if the module is already in /etc/modules
    if ! grep -qE "^${module}$" /etc/modules; then
        echo $module >> /etc/modules
    fi
done

# add config
config_start="# --- Pilot Config Start (do not modify) ---"
config_end="# --- Pilot Config End (do not modify) ---"

all_start="[all]"
pi4_start="[pi4]"

all_config="dtparam=spi=on
dtparam=i2c_arm=on
dtoverlay=pi3-miniuart-bt
dtoverlay=pilot
enable_uart=1
core_freq=250
init_uart_clock=48000000"

pi4_config="dtoverlay=uart2
dtoverlay=uart5"

# Remove blocks with markers
while grep -q "$config_start" /boot/config.txt; do
    sed -i "/$config_start/,/$config_end/d" /boot/config.txt
done

# Function to append config if block doesn't exist
append_config() {
    local block_start="$1"
    local config="$2"
    if ! grep -q "$block_start" /boot/config.txt; then
        echo "$config_start"
        echo "$block_start"
        echo "$config"
        echo "$config_end"
    fi
}

# Append configurations
append_config "$all_start" "$all_config" >> /boot/config.txt
append_config "$pi4_start" "$pi4_config" >> /boot/config.txt

# remove console from cmdline

if grep -q "console=serial0," /boot/cmdline.txt; then
    sed -i /boot/cmdline.txt -e "s/console=serial0,[0-9]\+ //"
fi

if grep -q "console=ttyAMA0," /boot/cmdline.txt; then
    sed -i /boot/cmdline.txt -e "s/console=ttyAMA0,[0-9]\+ //"
fi

# generate plc var loader
#
# Set execute permission only if not already set
if [ ! -x /etc/init.d/pilot-config ]; then
    chmod +x /etc/init.d/pilot-config
fi

# Create symbolic link only if it doesn't exist
if [ ! -L /etc/rc3.d/S01pilot-config ]; then
    ln -rs /etc/init.d/pilot-config /etc/rc3.d/S01pilot-config
fi
